-- ðŸ”’ SECURITY: Chat Attachments Storage
-- Bucket: chat_attachments (Private)

insert into storage.buckets (id, name, public)
values ('chat_attachments', 'chat_attachments', false)
on conflict (id) do nothing;

-- RLS Policies

-- 1. Admin Access (GOD MODE)
create policy "Admins can do everything on chat_attachments"
on storage.objects
for all
using (
  bucket_id = 'chat_attachments' 
  and public.is_admin()
)
with check (
  bucket_id = 'chat_attachments' 
  and public.is_admin()
);

-- 2. User Upload Access (Authenticated Users)
-- Users can upload files to a folder matching their project_id (logic enforced by app, RLS is broader here for simplicity but secure enough combined with signed URLs for read)
-- Actually, let's allow any authenticated user to INSERT, but we restrict the path.
-- Path convention: {project_id}/{filename}
-- We can't easily check 'project ownership' cheaply in storage RLS without complex joins.
-- So we allow INSERT for authenticated users, but READ is blocked.
create policy "Authenticated users can upload chat attachments"
on storage.objects
for insert
with check (
  bucket_id = 'chat_attachments' 
  and auth.role() = 'authenticated'
);

-- 3. READ Access (Strictly NONE for users directly)
-- Users must use Signed URLs generated by the server.
-- So NO 'select' policy for normal users.
